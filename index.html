<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vault</title>
    <style>
      /* --- General and Terminal Theme --- */
      body {
        background-color: #fff;
        color: black;
        font-family: monospace;
        line-height: 1.6;
        font-size: 1.05rem;
      }
      .header {
        display: flex;
        flex-direction: column;
        width: 100vw;
        align-items: center;
      }
      .content {
        margin-top: 1rem;
        min-width: 30vw;
        text-align: center;
      }

      h3 {
        text-transform: uppercase;
        letter-spacing: 2px;
      }
      .input-container {
        display: flex;
        align-items: center;
      }

      #password-input {
        /* Remove all default styling */
        border: none;
        outline: none;
        background-color: transparent;

        /* Match the terminal theme */
        font-family: inherit;
        font-size: 1.1em;
        padding-left: 0.5em;
        width: 100%;
      }

      /* --- JSON Output Styling --- */
      .copyable {
        cursor: pointer;
        background-color: #efefefef;
        padding: 2px 4px;
        border-radius: 3px;
      }

      #json-container {
        padding-left: 15px;
        margin-top: 20px;
      }

      /* Loading spinner */
      .spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #333;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 0.5rem;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div class="header">
      <div class="content">
        <h3>PASSWORD</h3>

        <div class="input-container">
          <label for="password-input">></label>
          <input type="password" id="password-input" autocomplete="off" />
        </div>

        <p id="status-message"></p>
      </div>
    </div>
    <div id="json-container"></div>

    <script type="module">
      // --- Configuration ---
      const VAULT_REPO = "antonio-leitao/inner-sanctum";
      const VAULT_FILE = "vault.enc";

      // --- Global Variables ---
      let wasmCrypto = null;
      let encryptedVault = null;

      // --- DOM Elements ---
      const passwordInput = document.getElementById("password-input");
      const statusMessage = document.getElementById("status-message");
      const jsonContainer = document.getElementById("json-container");

      // --- Initialize WASM and Load Vault ---
      async function init() {
        try {
          // Load WASM module
          statusMessage.innerHTML =
            '<span class="spinner"></span>Loading crypto module...';
          const wasmModule = await import("./pkg/crypto.js");
          await wasmModule.default();
          wasmCrypto = new wasmModule.WasmCrypto();

          // Load encrypted vault from repository
          statusMessage.innerHTML =
            '<span class="spinner"></span>Loading vault...';
          const response = await fetch(
            `https://raw.githubusercontent.com/${VAULT_REPO}/master/${VAULT_FILE}`,
          );

          if (!response.ok) {
            throw new Error(
              `Failed to load vault: ${response.status} ${response.statusText}`,
            );
          }

          encryptedVault = await response.json();

          statusMessage.textContent = "";
          passwordInput.disabled = false;
          passwordInput.focus();
        } catch (error) {
          console.error("Initialization failed:", error);
          statusMessage.textContent = `Error: ${error.message}`;
        }
      }

      // --- Real Password Validation ---
      async function validatePassword(password) {
        if (!wasmCrypto || !encryptedVault) {
          throw new Error("System not ready");
        }

        try {
          // Attempt to decrypt the vault with the provided password
          const decryptedJson = wasmCrypto.decrypt_json(
            JSON.stringify(encryptedVault),
            password,
          );
          const decryptedData = JSON.parse(decryptedJson);
          return decryptedData;
        } catch (error) {
          // Decryption failed - wrong password or corrupted data
          return null;
        }
      }

      // --- JSON Rendering (keeping original) ---
      function renderJson(data, parentElement) {
        for (const key in data) {
          if (Object.prototype.hasOwnProperty.call(data, key)) {
            const value = data[key];
            const itemDiv = document.createElement("div");
            itemDiv.style.marginLeft = "20px";
            const keySpan = document.createElement("strong");
            keySpan.textContent = `${key}: `;
            itemDiv.appendChild(keySpan);
            if (
              typeof value === "object" &&
              value !== null &&
              !Array.isArray(value)
            ) {
              parentElement.appendChild(itemDiv);
              renderJson(value, itemDiv);
            } else {
              const valueSpan = document.createElement("span");
              const displayValue = Array.isArray(value)
                ? JSON.stringify(value)
                : String(value);
              valueSpan.textContent = "********";
              valueSpan.className = "copyable";
              valueSpan.dataset.realValue = displayValue;
              valueSpan.addEventListener("mouseover", (event) => {
                if (event.target.textContent !== "Copied!") {
                  event.target.textContent = event.target.dataset.realValue;
                }
              });
              valueSpan.addEventListener("mouseout", (event) => {
                if (event.target.textContent !== "Copied!") {
                  event.target.textContent = "********";
                }
              });
              valueSpan.addEventListener("click", (event) => {
                const valueToCopy = event.target.dataset.realValue;
                navigator.clipboard
                  .writeText(valueToCopy)
                  .then(() => {
                    event.target.textContent = "Copied!";
                    setTimeout(() => {
                      event.target.textContent = "********";
                    }, 1500);
                  })
                  .catch((err) => {
                    console.error("Failed to copy text: ", err);
                    alert("Could not copy text to clipboard.");
                  });
              });
              itemDiv.appendChild(valueSpan);
              parentElement.appendChild(itemDiv);
            }
          }
        }
      }

      // --- Event Handlers (keeping original behavior) ---

      // Automatically focus the input when the page loads and on clicks
      document.addEventListener("click", (event) => {
        if (
          event.target !== passwordInput &&
          !event.target.classList.contains("copyable")
        ) {
          passwordInput.focus();
        }
      });

      // Handle password submission
      passwordInput.addEventListener("keydown", async (event) => {
        if (event.key === "Enter") {
          event.preventDefault();

          const password = passwordInput.value;
          if (password.length === 0) return;

          jsonContainer.innerHTML = "";
          statusMessage.innerHTML =
            '<span class="spinner"></span>Validating... Please wait.';
          passwordInput.disabled = true;

          try {
            const decryptedData = await validatePassword(password);

            if (decryptedData) {
              statusMessage.textContent = "Access Granted! Click to copy.";
              renderJson(decryptedData, jsonContainer);
              passwordInput.value = "";
            } else {
              statusMessage.textContent = "Access Denied.";
            }
          } catch (error) {
            console.error("Validation error:", error);
            statusMessage.textContent = "Error during validation.";
          }

          passwordInput.disabled = false;
          passwordInput.focus();
        }
      });

      // --- Start Application ---
      passwordInput.disabled = true;
      init();
    </script>
  </body>
</html>
